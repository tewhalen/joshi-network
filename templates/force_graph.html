<head>
  <style>
    body {
      margin: 0;
    }
  </style>

  <!--<script src="https://cdn.jsdelivr.net/npm/3d-force-graph"></script>-->
  <!--<script src="../../dist/3d-force-graph.js"></script>-->
</head>

<body>
  <div id="3d-graph"></div>
  <div style="position: absolute; top: 5px; right: 5px;">
    <button id="rotationToggle" style="margin: 8px; height: 25px; width: 150px;">
      Pause Rotation
    </button>
  </div>
  <script type="module">
    import * as THREE from 'https://esm.sh/three@0.154.0';
    // expose THREE globally for any libs that expect a global THREE
    window.THREE = THREE;
    import ForceGraph3D from 'https://esm.sh/3d-force-graph';
    import SpriteText from 'https://esm.sh/three-spritetext';

    const Graph = new ForceGraph3D(document.getElementById('3d-graph'))
      .jsonUrl({{ json_url }})
      .nodeAutoColorBy('group')
      .nodeLabel('promotion')
      .nodeThreeObject(node => {
        if (node.id === "x10962" || node.id === "196x17") {
          // Create a group for the glow and the normal node
          const group = new THREE.Group();
          // Glow: large, semi-transparent colored sphere
          const glowGeometry = new THREE.SphereGeometry(14, 32, 32);
          const glowMaterial = new THREE.MeshBasicMaterial({
            color: 0xffff00, // yellow glow
            transparent: true,
            opacity: 0.45,
            depthWrite: false
          });
          const glowMesh = new THREE.Mesh(glowGeometry, glowMaterial);
          group.add(glowMesh);
          // Normal node: smaller sphere
          const sphereGeometry = new THREE.SphereGeometry(8, 32, 32);
          const sphereMaterial = new THREE.MeshBasicMaterial({ color: node.color });
          const sphereMesh = new THREE.Mesh(sphereGeometry, sphereMaterial);
          group.add(sphereMesh);
          const sprite = new SpriteText(node.name);
          sprite.material.depthWrite = false; // make sprite background transparent
          sprite.color = node.color;
          sprite.textHeight = 16;
          sprite.center.y = -0.6; // shift above node
          group.add(sprite);
          return group;
        } else {
          // Default: show name as SpriteText
          const sprite = new SpriteText(node.name);
          sprite.material.depthWrite = false; // make sprite background transparent
          sprite.color = node.color;
          sprite.textHeight = 8;
          sprite.center.y = -0.6; // shift above node
          return sprite;
        }
      })
      .nodeThreeObjectExtend(true);


    const distance = 1400;
    // Spread nodes a little wider
    Graph.d3Force('charge').strength(-120);


    let isRotationActive = true;
    // camera orbit
    let angle = 0;
    setInterval(() => {
      if (isRotationActive) {
        Graph.cameraPosition({
          x: distance * Math.sin(angle),
          z: distance * Math.cos(angle)
        });
        angle += Math.PI / 300;
      }
    }, 10);
    document.getElementById('rotationToggle').addEventListener('click', event => {
      isRotationActive = !isRotationActive;
      event.target.innerHTML = `${(isRotationActive ? 'Pause' : 'Resume')} Rotation`;
    });

  </script>
</body>